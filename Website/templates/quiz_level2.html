{% extends 'base.html' %}

{% block title %}Level 2 Quiz{% endblock %}

{% block content %}
<style>
    body {
        background-color: #f2eadf;
    }

    h1 {
        text-align: center;
        margin-bottom: 20px;
        font-family: 'Times New Roman', Times, serif;
        color: #94693e;
        font-weight: bold;
    }

    .cat-box {
        width: 600px;
        height: 600px;
        position: relative;
        margin: auto;
        background-image: url("{{ url_for('static', filename='Images/cat_face_shape.png') }}");
        background-size: contain;
        background-position: center;
        background-repeat: no-repeat;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        font-size: 20px;
        font-weight: bold;
        color: white;
        padding: 20px;
    }

    .options {
        margin-top: -100px;
        position: relative;
        text-align: center;
        font-size: 30px;
        font-family: 'Times New Roman', Times, serif;
        top: -120px;
    }

    .options, input {
        margin: 10px;
        font-size: 30px;
        cursor: pointer;
    }

    #question-text {
        color: white;
        font-weight: bold;
        font-family: 'Times New Roman', Times, serif;
        max-width: 65%;
        word-wrap: break-word;
        overflow-wrap: break-word;
        font-size: 24px;
    }

    #question-counter {
        color: white;
        font-weight: bold;
        font-family: 'Times New Roman', Times, serif;
        margin-bottom: -60px;
        font-style: italic;
        font-size: large;
    }

    #countdown-box {
        font-weight: bolder;
        font-size: large;
        font-family: 'Times New Roman', Times, serif;
        text-align: center;
        margin-top: 100px;
    }

    #feedback {
        color: white;
        text-align: center;
        font-family: 'Times New Roman', Times, serif;
    }
</style>
<div style="padding: 20px;">
    <h1>Level 2</h1>

    <h2 id="question-counter" style="text-align: center; color: #6b4f2f;"></h2>

    <div id="countdown-box">
        <h2 id="countdown-text">Loading...</h2>
    </div>

    <div class="cat-box" id="cat-box" style="display: none;">
        <h2 id="question-text"></h2>
        <h2 id="feedback"></h2>
    </div>

    <div class="options" id="options"></div>
</div>

<script>
    let questions = [];
    let currentIndex = 0;
    let correctAnswer = ""; //Stores the correct answer temporarily
    let correctCount = 0; //Count the number of correct answers

    document.addEventListener("DOMContentLoaded", () => {
        startCountdown(); // Start countdown immediately when quiz page loads
    });

    function startCountdown() {
        let countdownText = document.getElementById("countdown-text");
        let countdownBox = document.getElementById("countdown-box");
        let catBox = document.getElementById("cat-box");
        let count = 3;

        let countdownInterval = setInterval(() => {
            countdownText.innerHTML = `Starting in ${count}...`;
            count--;

            if (count < 0) {
                clearInterval(countdownInterval);
                countdownBox.style.display = "none", //Hide countdown after it finishes
                catBox.style.display = "flex"; //Show the cat face shape
                fetchQuestions(); //Fetch questions after countdown ends
            }
        }, 1000); //Countdown updates every second
    }

    async function fetchQuestions() {
        const response = await fetch('/get_questions?level=2');
        let allQuestions = await response.json();

        //Select 10 completely random questions without relying on order
        questions = getRandomSubset(allQuestions, 10);
        currentIndex = 0;
        currentCount = 0;
        displayQuestion();
    }

    //Function to randomly select a subset of questions
    function getRandomSubset(arr, num) {
        let shuffled = arr.sort(() => Math.random() - 0.5); //Shuffle the array
        return shuffled.slice(0, num); //Take only 10 random questions
    }

    function displayQuestion() {
        if (currentIndex < questions.length) {
            let q = questions[currentIndex];

            correctAnswer = q.correct_option.toUpperCase().replace("OPTION_", ""); //Store the correct answer

            let shuffledOptions = shuffleOptions([
                { text: q.option_a, value: "A" },
                { text: q.option_b, value: "B" },
                { text: q.option_c, value: "C" }
            ]);

            //Update quesion counter
            document.getElementById("question-counter").innerHTML = `Question ${currentIndex + 1} of ${questions.length}`;

            //Update question text
            document.getElementById("question-text").innerHTML = q.question;

            //Display options
            document.getElementById("options").innerHTML = shuffledOptions.map(option =>
                `<input type="radio" name="option" value="${option.value}" onchange="checkAnswer()"> ${option.text} <br>`
            ).join("");
        } else {
            checkQuizCompletion();
        }
    }

    function checkAnswer() {
        let selectedOption = document.querySelector('input[name="option"]:checked');
        if (!selectedOption) {
            alert("Please select an answer.");
            return;
        }

        let userAnswer = selectedOption.value;

        document.getElementById("question-text").style.display = "none"; //Hide question when display feedback
        document.getElementById("options").style.display = "none"; //Hide options when display feedback

        if (userAnswer === correctAnswer) {
            correctCount++; //Increase correct answer count
            document.getElementById("feedback").innerHTML = "✅ Correct!";
        } else {
            document.getElementById("feedback").innerHTML = "❌ Wrong!";
        }

        setTimeout(() => {
            nextQuestion();
        }, 5000); //Delay 5 seconds before moving to the next question
    }

    function nextQuestion() {
        currentIndex++;
        document.getElementById("feedback").innerHTML = ""; //Clear previous feedback
        
        //Make question and options visible again for the next question
        document.getElementById("question-text").style.display = "block";
        document.getElementById("options").style.display = "block";
        displayQuestion();
    }

    function checkQuizCompletion() {
        document.getElementById("question-text").innerHTML = "Quiz Complete!";
        document.getElementById("options").innerHTML = "";

        if (correctCount === questions.length) {
            document.getElementById("question-text").innerHTML = "Congratulations! <br> You have completed Level 2 and earned your badge! <br> ฅ^•⩊•^ ฅ";
        } else {
            document.getElementById("question-text").innerHTML = "This is your final challenge! <br> Get every answer right to complete your journey and earn your badge. <br> Give it another shot!  <br> /ᐠ╥⩊╥ᐟ\\";
        }
    }

    function shuffleOptions(options) {
        for (let i = options.length - 1; i > 0; i--) {
            let j = Math.floor(Math.random() * (i + 1));
            [options[i], options[j]] = [options[j], options[i]];
        }
        return options;
    }
</script>
{% endblock %}
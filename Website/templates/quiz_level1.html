{% extends 'base.html' %}

{% block title %}Level 1 Quiz{% endblock %}

{% block content %}
<style>
    body {
        background-color: #f2eadf;
    }

    h1 {
        text-align: center;
        margin-bottom: 20px;
        font-family: 'Times New Roman', Times, serif;
        color: #94693e;
        font-weight: bold;
    }

    .cat-box {
        width: 350px;
        height: 350px;
        position: relative;
        margin: auto;
        background-image: url("{{ url_for('static', filename='Images/cat_face_shape.png') }}");
        background-size: contain;
        background-position: center;
        background-repeat: no-repeat;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        font-size: 20px;
        font-weight: bold;
        color: white;
        padding: 20px;
    }

    .options input {
        margin: 10px;
        font-size: 18px;
        cursor: pointer;
    }
</style>
<div style="padding: 20px;">
    <h1>Level 1</h1>

    <h2 id="question-counter" style="text-align: center; color: #6b4f2f;"></h2>

    <div class="cat-box">
        <h2 id="question-text">Loading...</h2>
    </div>

    <div class="options" id="options"></div>
</div>

<script>
    let questions = [];
    let currentIndex = 0;
    let correctAnswer = ""; //Stores the correct answer temporarily
    let correctCount = 0; //Count the number of correct answers

    document.addEventListener("DOMContentLoaded", () => {
        startCountdown(); // Start countdown immediately when quiz page loads
    });

    function startCountdown() {
        let countdownText = document.getElementById("question-text");
        let count = 3;

        let countdownInterval = setInterval(() => {
            countdownText.innerHTML = `Starting in ${count}...`;
            count--;

            if (count < 0) {
                clearInterval(countdownInterval);
                fetchQuestions(); //Fetch questions after countdown ends
            }
        }, 1000); //Countdown updates every second
    }

    async function fetchQuestions() {
        const response = await fetch('/get_questions?level=1');
        questions = await response.json();
        currentIndex = 0;
        currentCount = 0;
        displayQuestion();
    }

    function displayQuestion() {
        if (currentIndex < questions.length) {
            let q = questions[currentIndex];

            correctAnswer = q.correct_option; //Store the correct answer

            let shuffledOptions = shuffleOptions([
                { text: q.option_a, value: "A" },
                { text: q.option_b, value: "B" },
                { text: q.option_c, value: "C" }
            ]);

            //Update quesion counter
            document.getElementById("question-counter").innerHTML = `Question ${currentIndex + 1} of ${questions.length}`;

            //Update question text
            document.getElementById("question-text").innerHTML = q.question;

            //Display options
            document.getElementById("options").innerHTML = shuffledOptions.map(option =>
                `<input type="radio" name="option" value="${option.value}"> ${option.text} <br>`
            ).join("");
        } else {
            checkQuizCompletion();
        }
    }

    function checkAnswer() {
        let selectedOption = document.querySelector('input[name="option"]:checked');
        if (!selectedOption) {
            alert("Please select an answer.");
            return;
        }

        let userAnswer = selectedOption.value;

        if (userAnswer === correctAnswer) {
            correctCount++; //Increase correct answer count
            alert("Correct!");
        } else {
            alert("Wrong!");
        }

        setTimeout(() => {
            nextQuestion();
        }, 5000); //Delay 5 seconds before moving to the next question
    }

    function nextQuestion() {
        currentIndex++;
        displayQuestion(); g
    }

    function checkQuizCompletion() {
        document.getElementById("question-text").innerHTML = "Quiz Complete!";
        document.getElementById("options").innerHTML = "";

        if (correctCount === questions.length) {
            document.getElementById("question-text").innerHTML = "Congratulations! <br> You have unlocked level 2 and earned a badge! <br> ฅ^•⩊•^ ฅ";
        } else {
            document.getElementById("question-text").innerHTML = "You need to answer all correctly to unlock Level 2 and earn your badge. <br> Try again! <br> /ᐠ ╥ ˕ ╥マ ";
        }
    }

    function shuffleOptions(options) {
        for (let i = options.length - 1; i > 0; i--) {
            let j = Math.floor(Math.random() * (i + 1));
            [options[i], options[j]] = [options[j], options[i]];
        }
        return options;
    }
</script>
{% endblock %}